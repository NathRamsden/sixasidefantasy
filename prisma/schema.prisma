// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

enum DraftType {
  INITIAL
  REDRAFT
}

enum FixtureStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
}

enum CompetitionType {
  LEAGUE
  CUP
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String
  name         String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt


  // RELATIONS
  // League.owner → User (LeagueOwner relation)
  ownedLeagues League[] @relation("LeagueOwner")

  emailVerifiedAt DateTime?
  emailTokens     EmailVerificationToken[]

  // Team.user → User
  teams        Team[]

  // email preferences + tokens for auth/emails
  preferences  EmailPreferences?
  tokens       AuthToken[]
}

model Season {
  id        String     @id @default(cuid())
  name      String
  startDate DateTime
  endDate   DateTime

  createdAt DateTime   @default(now())

  gameweeks Gameweek[]
  leagues   League[]
}

model Gameweek {
  id        String   @id @default(cuid())
  seasonId  String
  season    Season   @relation(fields: [seasonId], references: [id])

  number    Int
  startAt   DateTime
  endAt     DateTime

  fixtures  Fixture[]
}

model Competition {
  id                String           @id @default(cuid())
  externalId        Int
  name              String
  country           String?
  type              CompetitionType?
  enabledForScoring Boolean         @default(true)

  createdAt         DateTime        @default(now())

  clubs             Club[]
}

model Club {
  id            String        @id @default(cuid())
  externalId    Int           @unique
  name          String

  competitionId String?
  competition   Competition?  @relation(fields: [competitionId], references: [id])

  players       Player[]
}

model Player {
  id           String       @id @default(cuid())
  externalId   Int          @unique
  name         String
  position     String?

  clubId       String?
  club         Club?        @relation(fields: [clubId], references: [id])

  fantasySlots TeamPlayer[]
  draftPicks   DraftPick[]
}

model League {
  id              String    @id @default(cuid())
  name            String
  code            String    @unique

  ownerId         String
  owner           User      @relation("LeagueOwner", fields: [ownerId], references: [id])

  seasonId        String
  season          Season    @relation(fields: [seasonId], references: [id])

  redraftGameweek Int       @default(19)
  createdAt       DateTime  @default(now())

  teams           Team[]
  fixtures        Fixture[]
  drafts          DraftSession[]
}

model Team {
  id        String       @id @default(cuid())

  leagueId  String
  league    League       @relation(fields: [leagueId], references: [id])

  userId    String
  user      User         @relation(fields: [userId], references: [id])

  name      String
  createdAt DateTime     @default(now())

  players       TeamPlayer[]

  homeFixtures  Fixture[] @relation("HomeTeam")
  awayFixtures  Fixture[] @relation("AwayTeam")

  draftOrders   DraftOrder[]
  draftPicks    DraftPick[]
}

model TeamPlayer {
  id          String    @id @default(cuid())

  teamId      String
  team        Team      @relation(fields: [teamId], references: [id])

  playerId    String
  player      Player    @relation(fields: [playerId], references: [id])

  acquiredAt  DateTime  @default(now())
  releasedAt  DateTime?
  acquiredVia String
  active      Boolean   @default(true)

  @@index([teamId, active])
}

model DraftSession {
  id          String      @id @default(cuid())

  leagueId    String
  league      League      @relation(fields: [leagueId], references: [id])

  type        DraftType

  startedAt   DateTime?
  completedAt DateTime?

  orders      DraftOrder[]
  picks       DraftPick[]
}

model DraftOrder {
  id             String       @id @default(cuid())

  draftSessionId String
  draftSession   DraftSession @relation(fields: [draftSessionId], references: [id])

  orderIndex     Int
  teamId         String
  team           Team         @relation(fields: [teamId], references: [id])

  @@unique([draftSessionId, orderIndex])
}

model DraftPick {
  id             String       @id @default(cuid())

  draftSessionId String
  draftSession   DraftSession @relation(fields: [draftSessionId], references: [id])

  round          Int
  pickNumber     Int
  teamId         String
  team           Team         @relation(fields: [teamId], references: [id])

  playerId       String
  player         Player       @relation(fields: [playerId], references: [id])

  createdAt      DateTime     @default(now())

  @@index([draftSessionId])
}

model Fixture {
  id          String        @id @default(cuid())

  leagueId    String
  league      League        @relation(fields: [leagueId], references: [id])

  gameweekId  String
  gameweek    Gameweek      @relation(fields: [gameweekId], references: [id])

  homeTeamId  String
  homeTeam    Team          @relation("HomeTeam", fields: [homeTeamId], references: [id])

  awayTeamId  String
  awayTeam    Team          @relation("AwayTeam", fields: [awayTeamId], references: [id])

  homeGoals   Int           @default(0)
  awayGoals   Int           @default(0)
  homePoints  Int           @default(0)
  awayPoints  Int           @default(0)

  status      FixtureStatus @default(SCHEDULED)

  createdAt   DateTime      @default(now())

  @@index([leagueId, gameweekId])
}

// =========================
// Email + auth extensions
// =========================


model EmailPreferences {
  id         String   @id @default(cuid())
  userId     String   @unique
  user       User     @relation(fields: [userId], references: [id])

  // toggles – we'll hook these into UI later
  newsletter Boolean  @default(true)   // general updates
  reminders  Boolean  @default(true)   // fixtures / drafts / results
  marketing  Boolean  @default(false)  // more promotional stuff
}

enum TokenType {
  EMAIL_VERIFY
  PASSWORD_RESET
}

model AuthToken {
  id        String    @id @default(cuid())
  user      User      @relation(fields: [userId], references: [id])
  userId    String
  type      TokenType
  token     String    @unique
  expiresAt DateTime
  createdAt DateTime  @default(now())
  usedAt    DateTime?

  @@index([userId, type])
}

model EmailVerificationToken {
  id        String   @id @default(cuid())
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  tokenHash String   @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime @default(now())
}
